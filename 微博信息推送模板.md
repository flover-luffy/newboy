# 微博信息推送模板

## 1. 个人微博推送模板

### 基础微博更新模板
```
【{用户名}微博更新】
{微博内容}
link: https://weibo.com/{用户ID}/{微博ID}
```

### 带图片的微博模板
```
【{用户名}微博更新】
{微博内容}
[图片1]
[图片2]
...
link: https://weibo.com/{用户ID}/{微博ID}
```

### 带视频的微博模板
```
【{用户名}微博更新】
{微博内容}
[视频封面图]
https://video.weibo.com/show?fid={视频ID}
link: https://weibo.com/{用户ID}/{微博ID}
```

### 转发微博模板
```
【{用户名}微博更新】
{转发评论内容}
------

转发自 {原博主}：
{原微博内容}
[原微博媒体内容]
link: https://weibo.com/{用户ID}/{微博ID}
```

### 图片+视频混合媒体模板
```
【{用户名}微博更新】
{微博内容}
[图片1]
[视频封面图]
https://video.weibo.com/show?fid={视频ID}
[图片2]
link: https://weibo.com/{用户ID}/{微博ID}
```

## 2. 超话推送模板

### 基础超话内容模板
```
【{超话名称}超话新内容：{发布者}】
{超话内容}
link: {原博链接}
```

### 带图片的超话模板
```
【{超话名称}超话新内容：{发布者}】
{超话内容}
[图片1]
[图片2]
...
link: {原博链接}
```

### 带视频的超话模板
```
【{超话名称}超话新内容：{发布者}】
{超话内容}
[视频封面图]
https://video.weibo.com/show?fid={视频ID}
link: {原博链接}
```

## 3. 文本处理规则

### HTML标签处理
- `<br>` → 换行符 `\n`
- `<.*?>` → 移除所有HTML标签
- `&#xe627;` → `▼` 符号

### 特殊字符处理
- URL中的 `\/` → `/`
- 转义字符 `\` → 移除
- `%2F` → `/`

## 4. 媒体资源处理

### 图片资源
- **单张图片**: 使用 `clear_picSrc` 获取原图
- **多张图片**: 解析 `clear_picSrc` 到 `thumb_picSrc` 之间的内容
- **图片上传**: 通过QQ群上传图片功能

### 视频资源
- **视频链接**: `https://video.weibo.com/show?fid={objectid}`
- **封面图片**: 使用 `cover_img` 或 `page_pic`
- **视频上传**: 上传封面图 + 视频链接

## 5. 时间处理

### 时间格式
- **个人微博**: 使用 `created_at` 字段，格式化为时间戳
- **超话内容**: 使用 `date` 字段，直接为时间戳
- **排序规则**: 按时间从小到大排序发送

### 去重机制
- **个人微博**: 基于用户ID维护 `endTime`
- **超话内容**: 基于超话ID维护 `endTime`
- **处理逻辑**: 只处理时间戳大于 `endTime` 的内容

## 6. 错误处理模板

### 超话错误处理
```
【超话播报处于测试版 请将以下信息提交至 https://github.com/Lawaxi/Newboy/issues/8】
错误微博：{微博链接}
```

### 资源获取失败
```
图片/视频资源获取失败，跳过媒体内容
```

### 用户主页无内容
```
{用户名}主页找不到任何东西
```

### 超话无内容
```
{超话名称}超话找不到任何东西
```

## 7. 网络请求配置

### 请求头设置
```
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
Referer: https://weibo.com/
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
Connection: keep-alive
```

### 资源获取
- **基础URL**: 使用异步HTTP客户端
- **图片资源**: 添加Referer头防止防盗链
- **重试机制**: 内置重试和错误处理

## 8. 数据结构

### messageWithTime类
```java
private class messageWithTime {
    public final Message message;  // 消息内容
    public final long time;        // 时间戳
}
```

### 订阅管理
- **个人微博**: `weibo_user_subscribe.get(group_id)` → `List<Long>`
- **超话订阅**: `weibo_superTopic_subscribe.get(group_id)` → `List<String>`
- **时间记录**: `HashMap<String, Long> endTime`

## 9. 发送流程

1. **收集消息**: 遍历订阅列表，收集所有新消息
2. **时间排序**: 按时间戳从小到大排序
3. **批量发送**: 依次发送到目标群组
4. **更新时间**: 更新各订阅源的 `endTime`

## 10. 配置示例

### 个人微博订阅
```json
"weibo_user_subscribe": {
    "群号": [用户ID1, 用户ID2, ...]
}
```

### 超话订阅
```json
"weibo_superTopic_subscribe": {
    "群号": ["超话ID1", "超话ID2", ...]
}
```

---

**注意事项**:
1. 微博监控采用游客登录方式，需要注意cookie失效问题
2. 超话内容按回复时间排序，需要遍历完全部内容
3. 个人主页按时间排序，可以提前终止遍历
4. 所有媒体资源都会自动下载并上传到QQ群
5. 转发微博支持递归解析，可以处理多层转发