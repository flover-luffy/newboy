# 口袋48视频和语音消息处理流程图

## 整体架构流程

```mermaid
flowchart TD
    A[口袋48消息接收] --> B[Pocket48Handler.getPocket48Message]
    B --> C[消息类型判断]
    C --> D[Pocket48Sender.pharseMessage]
    D --> E{消息类型}
    
    E -->|AUDIO| F[音频消息处理]
    E -->|VIDEO| G[视频消息处理]
    E -->|FLIPCARD_AUDIO| H[翻牌音频处理]
    E -->|FLIPCARD_VIDEO| I[翻牌视频处理]
    E -->|其他类型| J[其他消息处理]
    
    F --> K[音频格式检测与转换]
    G --> L[视频缩略图与视频流处理]
    H --> M[翻牌音频格式检测与转换]
    I --> N[翻牌视频预览图与视频流处理]
    
    K --> O[上传到QQ群]
    L --> O
    M --> O
    N --> O
    J --> O
    
    O --> P[发送消息到群聊]
```

## 音频消息处理详细流程

```mermaid
flowchart TD
    A1[接收音频消息] --> B1[获取音频URL]
    B1 --> C1{URL是否为空?}
    C1 -->|是| D1[返回错误消息]
    C1 -->|否| E1[通过getRes获取音频流]
    
    E1 --> F1{音频流是否可用?}
    F1 -->|否| G1[返回错误消息]
    F1 -->|是| H1[读取文件头16字节]
    
    H1 --> I1[AudioFormatDetector.detectFormat]
    I1 --> J1[检测音频格式]
    J1 --> K1{格式是否QQ兼容?}
    
    K1 -->|是| L1[直接使用原始音频流]
    K1 -->|否| M1[AudioFormatConverter.convertToAMR]
    
    M1 --> N1{转换是否成功?}
    N1 -->|是| O1[使用转换后的音频流]
    N1 -->|否| P1[使用原始音频流并记录警告]
    
    L1 --> Q1[创建ExternalResource]
    O1 --> Q1
    P1 --> Q1
    
    Q1 --> R1[group.uploadAudio]
    R1 --> S1[构建消息内容]
    S1 --> T1[返回Pocket48SenderMessage]
```

## 视频消息处理详细流程

```mermaid
flowchart TD
    A2[接收视频消息] --> B2[获取视频URL和预览图URL]
    B2 --> C2{URL是否为空?}
    C2 -->|是| D2[返回错误消息]
    C2 -->|否| E2[并行获取资源]
    
    E2 --> F2[通过getRes获取预览图流]
    E2 --> G2[通过getRes获取视频流]
    
    F2 --> H2{预览图流是否可用?}
    G2 --> I2{视频流是否可用?}
    
    H2 -->|否| J2[返回错误消息]
    I2 -->|否| J2
    H2 -->|是| K2[创建预览图ExternalResource]
    I2 -->|是| L2[创建视频ExternalResource]
    
    K2 --> M2[group.uploadShortVideo]
    L2 --> M2
    
    M2 --> N2[构建消息内容]
    N2 --> O2[返回Pocket48SenderMessage]
```

## 翻牌音频处理详细流程

```mermaid
flowchart TD
    A3[接收翻牌音频消息] --> B3[获取音频URL]
    B3 --> C3{URL是否为空?}
    C3 -->|是| D3[返回错误消息]
    C3 -->|否| E3[通过getRes获取音频流]
    
    E3 --> F3{音频流是否可用?}
    F3 -->|否| G3[返回错误消息]
    F3 -->|是| H3[读取文件头16字节]
    
    H3 --> I3[AudioFormatDetector.detectFormat]
    I3 --> J3[检测音频格式并记录详细信息]
    J3 --> K3{格式是否QQ兼容?}
    
    K3 -->|是| L3[直接使用原始音频流]
    K3 -->|否| M3[AudioFormatConverter.convertToAMR]
    
    M3 --> N3{转换是否成功?}
    N3 -->|是| O3[使用转换后的音频流]
    N3 -->|否| P3[使用原始音频流并记录警告]
    
    L3 --> Q3[创建ExternalResource]
    O3 --> Q3
    P3 --> Q3
    
    Q3 --> R3[group.uploadAudio]
    R3 --> S3[构建翻牌消息内容]
    S3 --> T3[包含提问者信息和回复内容]
    T3 --> U3[返回Pocket48SenderMessage]
```

## 翻牌视频处理详细流程

```mermaid
flowchart TD
    A4[接收翻牌视频消息] --> B4[获取视频URL和预览图URL]
    B4 --> C4{URL是否为空?}
    C4 -->|是| D4[返回错误消息]
    C4 -->|否| E4[并行获取资源]
    
    E4 --> F4[通过getRes获取预览图流]
    E4 --> G4[通过getRes获取视频流]
    
    F4 --> H4{预览图流是否可用?}
    G4 --> I4{视频流是否可用?}
    
    H4 -->|否| J4[返回错误消息]
    I4 -->|否| J4
    H4 -->|是| K4[创建预览图ExternalResource]
    I4 -->|是| L4[创建视频ExternalResource]
    
    K4 --> M4[group.uploadShortVideo]
    L4 --> M4
    
    M4 --> N4[构建翻牌视频消息内容]
    N4 --> O4[包含提问者信息和回复内容]
    O4 --> P4[返回Pocket48SenderMessage]
```

## 音频格式转换详细流程

```mermaid
flowchart TD
    A5[AudioFormatConverter.convertToAMR] --> B5[检查FFmpeg可用性]
    B5 --> C5{FFmpeg是否可用?}
    C5 -->|否| D5[返回null]
    C5 -->|是| E5[创建临时输入文件]
    
    E5 --> F5[将音频流写入临时文件]
    F5 --> G5[创建临时输出文件]
    G5 --> H5[构建FFmpeg命令]
    
    H5 --> I5["ffmpeg -i input.tmp -ar 8000 -ac 1 -ab 12.2k -f amr output.amr"]
    I5 --> J5[执行FFmpeg进程]
    
    J5 --> K5{转换是否成功?}
    K5 -->|否| L5[清理临时文件并返回null]
    K5 -->|是| M5[读取输出文件为InputStream]
    
    M5 --> N5[清理临时文件]
    N5 --> O5[返回转换后的音频流]
```

## 音频格式检测流程

```mermaid
flowchart TD
    A6[AudioFormatDetector.detectFormat] --> B6[检查文件头字节]
    B6 --> C6{匹配格式签名}
    
    C6 -->|23 21 41 4D 52| D6[AMR格式]
    C6 -->|02 23 21 41 4D 52| E6[AMR-WB格式]
    C6 -->|49 44 33| F6[MP3格式]
    C6 -->|FF FB 或 FF F3 或 FF F2| G6[MP3格式]
    C6 -->|52 49 46 46 + 57 41 56 45| H6[WAV格式]
    C6 -->|4F 67 67 53| I6[OGG格式]
    C6 -->|66 74 79 70| J6[MP4格式]
    C6 -->|其他| K6[UNKNOWN格式]
    
    D6 --> L6[返回AMR]
    E6 --> L6
    F6 --> M6[返回MP3]
    G6 --> M6
    H6 --> N6[返回WAV]
    I6 --> O6[返回OGG]
    J6 --> P6[返回MP4]
    K6 --> Q6[返回UNKNOWN]
```

## 关键组件说明

### 1. 核心处理类
- **Pocket48Sender**: 主要的消息解析和发送类
- **Pocket48Handler**: 消息获取和预处理
- **AudioFormatConverter**: 音频格式转换工具
- **AudioFormatDetector**: 音频格式检测工具
- **Pocket48ResourceHandler**: 资源流获取处理

### 2. 支持的音频格式
- **兼容格式**: AMR, AMR-WB, SILK
- **需转换格式**: MP3, WAV, OGG, MP4等
- **转换目标**: AMR格式 (8kHz, 单声道, 12.2kbps)

### 3. 视频处理特点
- 需要同时处理视频文件和预览图
- 支持翻牌视频的特殊格式
- 自动生成文件名包含时间戳

### 4. 错误处理机制
- URL验证
- 资源流可用性检查
- 格式转换失败回退
- 详细的错误日志记录

### 5. 性能优化
- 并行获取视频和预览图资源
- 临时文件自动清理
- 流式处理避免内存溢出